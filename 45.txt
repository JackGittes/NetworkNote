计算机网络原理笔记 45
Internet基本原理（七）
作者：赵明心    日期：2019/04/23

本节课学习自治系统之间的路由协议。不同于自治系统内部的路由协议，RIP和OSPF。

7.7 外部网关路由协议BGP
    1、因特网的规模太大，使得自治系统路由选择非常困难
    2、BGP是不同自治系统的路由器之间交换路由信息的协议
    3、BGP是一种距离向量路由算法

7.7.1   BGP发言人与会话
    1、每一个自治系统的管理员要选择至少一个路由器作为该自治系统的“BGP发言人”
    2、BGP发言人往往就是BGP边界路由器
    3、BGP发言人之间要交换路由信息，就要建立BGP会话（Session）

    若干个自治系统之间的路由信息交换就是发言人完成的。当判断在本网段、在本自治系统内部进行数据转发的时候，就使用RIP和OSPF协议进行数据转发，如果是在不同自治系统之间进行数据转发，就使用发言人来进行路由转发。

7.7.2   边界网关协议BGP
    1、建立了BGP会话连接的路由器又被称作对等体（peers or neighbors），对等体的连接有两种模式：IBGP（Internal BGP）和EBGP（External BGP）

    EBGP是连接不同自治系统之间的邻居，IBGP是一个自治系统内部的邻居。
    
    IBGP：用来在AS内部完成BGP更新信息的交换，维护AS内部连通性
    EBGP：用来建立AS之间的路由器会话

7.7.3   BGP的特点
    1、采用路径向量（path vector）算法，路由信息中记录路径的轨迹
        （1）与距离矢量法非常类似
        （2）每个边界网关向邻居路由器广播到目的节点完整路径
        （3）例如：网关X可能发送到目的节点Z的路径如下：
            Path(X,Z)=X,Y1,Y2,Y3...Z
    2、假设：网关X将它的路径发送到网关W
        （1）W可能接受或者不接受X所提供的路径
        （2）如果W接受X发来的路径，则：
            Path(W,Z)=W, Path(X,Z)
        （3）注意：X可以通过控制是否广播某条路径来控制该路径的流量

7.7.4   BGP报文格式和消息类型
    1、打开（Open）报文：用来与相邻的另一个BGP发言人建立关系
    2、更新（Update）报文：用来发送某一路由的信息，以及列出要撤销的多条路由
    3、保活（Keepalive）报文：用来确认打开报文和周期性地证实邻站关系
    4、通知（Notification）报文：用来发送检测到的差错

    路由信息更新，增删路由的时候需要将路由信息扩散给相邻接点，这个时候需要发送更新报文。

TCP/IP网络层协议就到此为止，在网络层上的典型协议是IP协议，关于IP地址分配、报文格式、分组转发（包括v4和v6）。还包括其他的一些协议，例如ICMP（ping命令，ICMP的一种报文），IGMP组播协议，ARP/RARP用于地址解析和反地址解析，还有一些网络层路由协议RIP/OSPF/BGP。回忆一下网络体系结构，在网络层之上还有一层传输层。

7.8 传输层协议
    网络层协议已经足够完成数据分组的转发，引入传输层的原因有：
        （1）消除网络层的不可靠性
        （2）向上层屏蔽通信子网的实现细节
        （3）弥补上次提出要求和下层提供服务之间的差异
    
    应用层          |     用户功能
    运输层          |
    网络层          |
    数据链路层      |     网络功能
    物理层          |

    网络层之下的部分位于通信子网内，主要解决一些通信功能，在通信子网之上和具体设备相关的称为资源子网，而在中间的部分增加的就是传输层。传输层位于资源子网的末端，位于通信子网的最上端。

7.8.1   传输层服务

                标准的服务界面（用户要求）
        运输层协议A                 运输层协议B

                                通信子网B提供的服务
        通信子网A提供的服务 

        
        电信网和Internet来比较的话，电信网的服务质量会更高一些。电信网在服务质量、延迟、丢包率上的服务保障是远高于Internet的。对于用户而言，其终极目标都是要求服务质量足够好，这时候需要引入传输层保障。       

7.8.2   传输层的作用范围
    1、提供源端主机到目的端主机的可靠传输

    主机A ---- LAN1 ---- 路由器1 ----- WAN ----- 路由器2 ---- LAN2 ----- 主机B 
    应用进程                                                             应用进程
            |---------------------IP协议作用范围-----------------------|
     |---------------------运输层协议TCP和UDP的作用范围 -------------------|  

    运输层关心的主机的进程之间的通信，相对于IP协议而言扩大了范围。进程间是端到端访问，是端口之间进行的。

7.8.3   应用进程之间的通信
    1、运输层提供“进程级”的访问能力
    2、两个主机进行通信实际上就是两个主机中的应用进程互相通信
    3、应用进程之间的通信又被称为“端到端通信”
    4、运输层的另一个重要功能就是复用和分用

7.8.4   传输服务
    1、传输实体：完成传输层功能的硬软件
    2、传输层实体利用网络层提供的服务向高层提供有效、可靠的服务，用服务质量QoS衡量
    3、传输层提供两种服务：
        （1）面向连接的传输服务：连接建立、数据传输、连接释放
        （2）无连接的传输服务：不可靠的传输

    在传输层的实体指的其实就是端口，而网络层的传输实体就是主机。

7.8.5   传输服务原语
    此处略去了一张表格，是TCP/UDP服务的传输服务原语。
    1、建立连接：request用于建立连接的请求，indication用于确认进行连接，response（A对B的响应，属于TCP的三次握手协议），confirm（A发往B的确认信息）

    2、拆除连接
    3、数据传输：DATA.request...
    4、无连接数据传输

7.8.6   传输服务的要素
    这部分是跟TCP协议相关的概念。
    1、寻址方法：定义传输服务访问点TSAP，将应用进程与这些TSAP相连
    2、Internet中，TSAP内容如下：
        (IP Address, Local port)

    服务访问点的概念并不陌生，在网络层就是IP地址。通过端口来进行进程之间的通信。80端口之间就是HTTP协议，20端口之间就是FTP的连接请求。在传输层一定要落实到某个端口上的通信，在网络层是不关心端口的。

    服务访问点TSAP

               主机A                                   主机B
            运输服务用户                            运输服务用户
           （应用层实体）                           （应用层实体）
    运输层服务访问点 TSAP（端口）                                          层接口
           
           运输实体---------------运输协议-------------运输实体            运输层

    网络层服务访问点NSAP           网络层（网际层）                         层接口

    传输层常用的端口号：
    应用层协议                    网络应用              常用端口号
    SMTP                       电子邮件发送              25
    POP                        电子邮件接受             110
    FTP                        远程文件传输             20，21
    Telnet                      虚终端                  23
    HTTP                        Web服务                 80
    DNS                         域名解析                53
    SNMP                        网络管理                161，162
    
    自己使用的Web服务端口一般是8080，外部访问自己搭建的网站一般是80。

    3、远方客户程序如何获得服务程序的TSAP？
        （1）方法1：预先约定、广为人知的，比如telnet是（IP地址，端口23）
        （2）方法2：从名字服务器（name server）或目录服务器（directory server）获得TSAP
    
7.8.7   传输层寻址（Addressing）
    1、当服务程序很多时，使用初始链接协议（initial connection protocol）
        （1）一个称为进程服务器（process server）的进程（inetd）同时在多个端口上监听
        （2）远方客户程序向它实际想访问的服务程序的TSAP发出连接建立请求
        （3）如果没有服务程序在此TSAP上监听，则远方客户和进程服务器建立连接
        （4）进程服务器产生所请求的服务进程，并使该进程继承和远程客户的连接
        （5）进程服务器返回继续监听
        （6）远方客户程序与所希望的服务程序进行数据传输
    这部分内容不在课堂上讲授。

    寻址过程：
        （1）注册进程连接到公用TSAP上
        （2）用户进程与公用TSAP相连接
        （3）注册进程使文件服务运行，并给它分配TSAP
        （4）文件服务进程连接到指定的TSAP
        （5）注册进程将进程地址通知用户进程
        （6）用户与文件服务进程连接

7.8.8   面向连接传输层协议的设计
    1、分段和组装
        （1）网络层PDU长度小于传输层PDU
        （2）对传输层PDU进行分段
    2、拼接和分割
        （1）对传输层PDU进行拼接
    3、多路复用和分流
        多个传输连接映射到一个网络连接上
    4、流量控制和缓冲管理
