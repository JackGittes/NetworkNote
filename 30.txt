计算机网络原理笔记 30
局域网技术（十）
作者：赵明心    日期：2019/03/27

以太网发展到千兆之后，为了保证前后兼容性，在MAC帧格式、最短帧长度上都没有作改动。
那么最开始的最短帧长度是怎么得到的呢？根据传播时间乘以发送的速率得到发送的数据最小为64个字节，链路层设计最小64字节就是为了保证发送端最少占用物理链路51.2us的时间。但是到了千兆以太网情况就不一样了，千兆以太网占用的时间只有10M以太网发送64字节的1/10，这样发送时间变短意味着局域网端到端的网络跨距变小，按比例换算的话，千兆以太网的最大跨距只有20米。这对于实际应用来说是远远不够的，一个机房从一个角到另一个角的距离很多时候就不止20米。为了使千兆以太网也能满足正常的组网跨距，关键点就在于发送端需要在发送数据的时候占据信道足够长的时间，至少51.2us。尤其是像发送64字节这样的短帧，如何延长占据时间？

一个简单的方式就是要求发送的帧长变长，在10M以太网的时候也设置了填充字段满足64个字节的长度要求，这个时候按道理说就是填充的更大就行了。从思路上来说没有问题，但是这样会带来问题，千兆网的MAC帧和10M、100M以太网的MAC帧就不同了，破坏了兼容性。怎样延长信道占用时间？这时候需要使用载波扩展技术。

5.8.1   载波扩展
    1、根本目的在于扩展网络的物理覆盖范围，由物理层控制，而帧填充是由链路层控制
    2、共享式千兆时间槽增加到512B，10M和100M的Ethernet都是64B
    3、最小帧长度保持在64B
    4、发送的数据帧超过512B，则无需载波扩展，若处于64B～512B之间，需要载波扩展

    | 前同步码 | 目的地址 | 源地址 | 数据长度 | 数据 | FCS | 载波延伸
              |------MAC帧的最小值=64字节---------------|
              |--------加上载波延伸的MAC帧长度=争用期长度512字节----|
    |-----------以太网实际传输的帧长度----------------------------|

    载波延伸，当前节点还在继续占用信道，别的节点检测的时候还会发现信道处于占用状态。对于MAC帧发送的短小帧，为了保证有足够的信道控制时间，就需要载波扩展。载波扩展并不是对于所有帧都扩展。超过512字节的时候不需要进行扩展。使用了载波扩展之后前面说的问题都解决了，扩展了组网的距离，这是载波扩展带来的好处，但是载波扩展也有负面作用。极端情况下，MAC层向物理曾提交的就是64字节，物理层进行载波延伸的时候中间差了7倍，这样有效信息只占据了1/8。载波延伸对于上层来说是没有意义的。对于一个短帧来说问题还不大，如果MAC层有连续多个短帧问题就大了。为了提高信道的使用效率，出现了帧突发技术。

5.8.2   帧突发技术
    如果一个发送端在一个突发期内存在多个待发送的短帧，没有必要对所有的短帧都进行扩展，可以使一个短帧发送的时候，其他的短帧捎带着其他的短帧过去，以搭便车的方式发送多个。

    1、在发送数据帧的同时启动突发定时器
    2、选择发送另一数据帧条件
        （1）存在待发送数据帧
        （2）突发定时器尚未失效
    3、突发前的第一个数据帧需要载波扩展，突发期间的数据帧不需要
    4、所有的发送数据帧长度之和不得超过1500B

                |<------------------将突发计时器设定为1500字节---------->|
    载波监听     |<----------争用期512字节---->|

    发送的数据   |分组1| RRRRRRRRRRRRRRRRRRRRR|分组2 | RRRR | 分组3 RRRR| 分组4
                         载波延伸     

    搭便车的条件是不能超过总长度，也就是只有若干短帧可以搭便车。注意帧间最短间隔还是要满足的。帧突发是针对载波扩展产生的信道利用低下产生的技术。

    用户主机一般连接在最末端，有时候还是10M交换机，10M交换机对于用户来说是足够的。        
5.9 10吉比特以太网
    1、与10Mb/s,100Mbps,1Gbps以太网的帧格式完全相同
    2、不使用铜线而只使用光纤
    3、只工作在全双工方式
    4、物理层类型：
        （1）局域网类型：10Gb/s
        （2）可选广域网物理层：OC-192/STM-64
            使10吉比特以太网的帧能够插入到OC-192/STM-64帧的有效载荷中，数据率为9.95328Gb/s
    
    10Gbps以太网有很多不同于其他以太网的部分，介质上，10Gbps无法连接普通交换机，只能够连接光纤交换机，而且只工作在全双工模式意味着CSMA/CD协议失效，从这点来看，除了帧格式以外，从物理层上的媒介访问控制都发生了彻底地变化，抛开帧格式来看，10Gbps以太网已经不能算作是局域网。这个时候的10Gbps已经可以支持广域组网需求，并且输出端使用的是全双工点到点连接，是广域网的连接方式。广域网的主流光网通信速率是9.95328Gbps，这时候局域网可以直接进入广域网。以太网交换机可以跨过路由器直接进入广域网。

5.10    虚拟局域网
    1、虚拟局域网VLAN是由一些局域网网段构成的与物理位置无关的逻辑组
        （1）这些网段具有某些共同的需求
        （2）每一个VLAN的帧都有一个明确的标识符，指明发送这个帧的工作站是属于哪一个VLAN
    2、虚拟局域网其实只是局域网给用户提供的一种服务，而并不是一种新型局域网
    3、虚拟局域网的优点：
        （1）网络设备的移动、添加和修改的管理开销减少
        （2）可以控制广播风暴
        （3）可提高网络的安全性

    物理局域网需要和物理的拓扑相对应，而且存在一个非常重要的概念：广播域。有时候一个广播信息只面向某些人员，这样需要在一个物理网络中隔离出一个特定的局部广播范围，这种需求是诞生虚拟局域网的一个重要原因。一家公司包含了多个部门，每个部门有各自的联系方式处理机制，则可以借助虚拟局域网的方式隔离。

    网段具有共同需求，主要是工作需求、工作特点，在一个物理局域网中划分多个逻辑组出来。虚拟局域网只能建立在交换机的基础之上，集线器是无法限制转发流量限制的。虚拟局域网的目的就是有目标的转发某些数据，屏蔽某些数据。

    网络范围比较大的时候，单一交换机是无法连接的，单一交换机的情况下，建立虚拟局域网是很容易的，只需要定义135端口连接哪些机器属于哪些VLAN，246端口对应哪些机器和VLAN。多交换机的情况下配置虚拟局域网就稍微复杂一些，这时候需要交换机进行维护和协商，将属于同一个VLAN的端口进行分类，如果交换机之间不清楚各自之间端口VLAN对应关系，有一个VLAN发送广播数据的时候就无法进行处理。

5.10.1  虚拟局域网的划分方法
    1、基于端口的划分
        （1）单交换机端口定义
        （2）多交换机端口定义
    2、基于MAC地址的划分
    3、基于网络层的划分
    4、基于IP组播的划分

    交换机之间有专门的交互协议，虚拟局域网的维护和管理不是自动的，不像网桥一样完全透明，虚拟局域网必须有手工配置，交换机没办法识别哪些是同一个VLAN。基于端口的方式是最接近底层的方式，最物理机械的方式，这种方式一旦划分好之后，如果某个成员工作地点发生了改变，例如从1楼改到5楼，此时的网络接口肯定发生了变化，这个变化之后虚拟局域网肯定也需要进行相应调整，从端口中取消1楼的端口加上5楼的端口。

    第二种基于MAC地址的划分，是从用户的网卡地址来划分的。同样地，1楼和11楼的工作人员的MAC地址不同，按照MAC地址进行划分。这个也可以看到，用户的接入端口会变化，用户的MAC地址也会变化，例如更换电脑导致MAC地址不一样。因此MAC地址改变之后也要在原来的VLAN中删除原来的旧MAC地址。

    由此类似可以向上推移到网络层。网络层有多种协议，在以太网构建的网络层中，可以支持IP协议、IPX协议、AppleTalk协议。基于网络协议类型可以进行VLAN划分，但是这种划分比较少，在网络中几乎互联网一统天下，所以需要基于单一网络协议的划分方式。单一网络协议的划分可以借助IP地址划分方式，IP子网可以划分成一个VLAN。
    
    基于网络层、基于MAC地址等都是小范围的划分方式。而基于IP组播的方式可以使VLAN的覆盖范围扩展到整个互联网范围，组播的VLAN在实际上已经不再是局域网了，数据的广播已经突破了物理上的广播域范围，相当于在整个互联网中选择部分用户作为VLAN。在互联网中，很少进行面向全体成员的广播，IP广播仅限于某个特定物理网段的广播。

    此处略去一张图，VLAN示意。VLAN的方式也可以避免广播风暴的发生，VLAN中的用户只是物理网络覆盖中的一个子集，VLAN之间也可以进行通信，但是在MAC层是做不到的，MAC已经完成了VLAN相互之间的屏蔽，VLAN之间的通信必须借助于上层，借助路由。我们通过IP之间的路由才能实现VLAN之间的数据传输。