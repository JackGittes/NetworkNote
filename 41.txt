计算机网络原理笔记 41
Internet基本原理（三）
作者：赵明心    日期：2019/04/13

之前讲解了Internet网络层IP协议地址分配的问题，实际上还有一个关键是设计网关。

7.4 IP分组及转发
    1、使用TCP/IP协议的网络层传输的基本数据单元（PDU）称为IP分组
    2、通过IP分组完成不可靠、无连接的数据传输
    3、IP分组由分组头（IP头）和数据区两部分组成

    物理层的PDU是01比特，数据链路层PDU是数据帧，网络层的数据是分组，IP分组上加上帧头帧尾构成帧，IP分组之上是报文。IP分组是独立路由的，而且IP协议不负责正确性问题，有相应的其他部分完成可靠性控制，IP协议的关键是怎么样完成转发。

7.4.1   IP分组格式
    此处略去一张图，介绍IP分组的数据格式。

    固定部分是IP分组头，剩下的数据部分是有效信息。如果传输的内容很大，则会切分成若干个分组进行传送。重点关注的是第一个字段，固定的20个字节，通过可选部分可以扩展成60个字节，所以头部分一般是20~60个字节。

7.4.2   IP分组头
    1、版本域（VERS）
        长度为4比特，表示与IP分组对应的IP协议版本号，目前广泛使用的是IPv4
    2、头部长度（HLEN）
        IP分组头长度，最小为5,最大为15,单位是32位
    3、服务类型域（Type of Service，TOS）
        （1）3个优先级位
        （2）3个标志位：D（Delay）、T（Throughput）、R（Reliability）
        （3）2个保留位
    在目前的IPV4协议中，没有使用到优先级位，因为数据报服务不支持优先级。IPV4没有用到服务域。但是后续有一些协议具有这种服务域信息。

    4、总长度域（Total Length）
        占16bit,指IP分组头和数据部分的总长度，单位为字节，因此数据报的最大长度为65535字节
    
    5、标识域（Identification）
        占16bit，用于唯一标识IP分组，用于IP分组的分段和重组
    
    6、标志位
        （1）DF：Dont Fragment
            用于指明IP分组是否允许分段，DF=0时为允许
        （2）MF：More Fragment
            用于表明是否有后续分段，MF=0标识最后一个分片
    
    计算IP分组数据部分的大小，可以直接使用总长度域减去分组头部，一个IP分组长度最大可以达到65535字节。大于此长度就无法传送这个IP分组。

    标识域主要用于数据的分段和重组，例如AB之间传输数据经过了两个路由器，实际上每个路由器转发的单位是一个个的IP分组，转发的时候有不同的长度限制，有的可以转发长一点的，有的转发短一点的，例如传递一个报文，R1路由器只能传递其中的一半大小，R2也许只能传递其中的三分之一，所以这个时候就需要进行分组，分组之后就需要进行重组。

    如果是把原始的报文或分组拆分成若干个，如何才能保证之后能按序重新组装呢？这就需要进行唯一的编号，例如拆分的时候按序编号拆分，之后在接受的时候再按序重组。与之相关的是标志位，标志位有两个比较常用的标志位，一个为DF位，当DF置为0的时候，表示IP分组允许分段，反之不可以拆分。MF用于表示当前分组是否是最后一个分组。当MF=0的时候表示当前是最后一个。如果路由器接收到一个分组，这个时候识别DF位为0,MF=1,这时候路由器知道后续还会有分组到达，就需要继续等待，如果MF=0,意味着路由器可以对数据进行重装。

    7、段偏移量（Fragment offset）
        （1）用于标明报文片在原始分组中的位置，分段和重组必用
        （2）除最后一个段外的所有段的长度必须是8字节（基本段长）的倍数

    注意这个被8字节整除是数据部分整除，例如1500总长度的时候，分组头长度为20,这个时候长度为1480数据，1480/8余数为0,表示可以进行分组。

    此处略去一张图，介绍IP分段与重组的示例。

    实际传输的时候，看到MF=1,标明后续有分组，同时看到段偏移量不为0,标明这是中间的分组，然后根据后续的帧的偏移量和MF标识来进行重组。当有更多的分组的时候，根据段偏移量的大小和MF位可以实现IP分组的分组和重装。

    8、生存期（Time to live）
        8比特，用于指明IP分组在网络中传输的最长时间，IP包每经过一个路由器TTL减1,为0则分组被丢弃
    
    9、协议域（Protocol）
        上层为哪种协议，如TCP、UDP等
    
    10、头校验和（Header checksum）
        （1）只对IP包头做校验
        （2）算法：每16位取反，循环相加（进位加在末尾），和再求反
        （3）有简单算法

    11、源地址（Source address）和目的地址（Destination address）
        32位IP地址

    实际上IP分组通过10秒还是10分钟的传送这个是需要根据网络实际的流量状况来看的，所以生存期是按照IP分组转发的跳数来决定的。如果IP分组传送的跳数超过了预设的最长跳数，则丢弃，这样避免了网络中很难到达目的方的分组造成网络流量过多。这样紧接着带来一个问题，一个分组因为跳数过多而被撤销之后，需要增加一些机制来弥补这种问题，也就是需要重传机制，目的方在一定时间内没有收到数据的时候就需要发送方进行重传。ping命令可以进行查看跳数，TTL标识了生存期。

    IP分组校验是16位取反相加的方式进行的。

    12、选项（Options）
        有时候填充有时候不填充
    
7.4.3   IP分组的转发
    1、在Internet中，IP分组的转发具有如下特点：
        （1）每个IP分组包含目的主机的IP地址
        （2）IP地址中的网络地址唯一标识Internet中的一个物理网络
        （3）所有连接到相同物理网络的主机和路由器共享其地址中的网络地址部分，它们在这个网络上可以直接通信
        （4）Internet中的每个物理网络至少有一个与之相连的路由器
    
    例如A主机202.117.15.2需要发往202.117.14.3，如果使用标准的C类掩码，这两个主机之间不可以进行直接的相互通信。由255.255.255.0与各自的IP地址进行相与的时候，可以看到网络号是不同的。这个时候就需要进行路由转发。

    A --- R1 --- R2 --- B
          |
          R3

    由于A和B不在同一个网段，需要将数据发送到边界路由器或者是网关，这个时候需要查找路由表，根据数据的目的地址查找对应R1的路由表，由于路由器记录了相关的下一跳的地址和目的地址，R1可能还会连接了其他的路由器，R1查找了路由表之后发现数据需要发送到R2,这个时候R2继续查询是否已经到达了B的网段，继续查找。

    在整个过程中，每个IP分组需要携带一些信息告知路由器如何进行转发。

    每个网络必须有一个路由器相连，避免成为孤立的节点，如果B所在网络没有路由器连接到Internet上，这时B只能在本网段内进行广播。

    3、在路由器中根据目的IP地址，进行路由转发
    4、路由器中的路由表格式如下面所示：
        目标网络        下一个路由器        距离
        20.0.0.0        直接投递            0
        30.0.0.0        直接投递            0
        10.0.0.0        20.0.0.5           1
        40.0.0.0        30.0.0.7           1

    5、在路由表中，目标网络通常是IP地址和子网掩码的形式来描述。

    在windows上可以使用route print查看路由表，在linux上直接使用route可以打印路由表，第一个显示目的网络号，后面是子网掩码，网关、Metric是距离。

    子网互联示意：

    202.1.64.1      202.1.64.3      202.1.64.3         202.1.64.0
       |                |               |              
    -----------------------------------------------------子网1
               202.1.64.5     |
                            路由器        掩码：255.255.255.0
               202.1.61.6     |
    -----------------------------------------------------子网2
       |                |               |              202.1.61.0
    202.1.61.1      202.1.61.3      202.1.61.3

    路由器可以有16口的，记录下一个网段。两个子网的网络号，可以看出两个子网分别为：202.1.64.0和202.1.61.0，这个时候两个不再一个网段，需要进行路由。路由器的端口要求连接不同的网络，如果配置成了相同的网络，就无法ping通。

    在同一个局域网上的主机或路由器的IP地址中的网络号必须是一样的，图中的网络号就是IP地址中的net-id。

    注意：路由器总是具有两个或两个以上的IP地址，路由器的每个接口都有一个不同网络号的IP地址。R1\R2\R3在分配地址的时候就是在每个相连的网络内，分配一个对应相连子网的一个网络IP地址。