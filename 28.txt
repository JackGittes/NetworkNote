计算机网络原理笔记 28
局域网技术（八）
作者：赵明心    日期：2019/03/19

网桥接受数据的时候是明确的可以对应到源MAC地址和输入端口号，这样可以绑定一个MAC地址和端口，这样就是逆向学习，根据输入端口和源来获得绑定的表项。由于计算机网络的数据传输都是双向的，这样就可以根据发送数据和反馈数据过程中的反向绑定来学到各个MAC地址和对应端口的关系。这样就解决了端口号和MAC地址的学习问题。

刚才所描述的仅仅是创建和增加表项，但是已经存在的表项还需要更新和维护，之后的连接关系可能会发生变化，所以需要对映射关系进行维护和刷新。维护刷新的过程就是周期性检查，看看是否一致，如果一致就保留，不一致的话简单的处理方式就是删除。

5.5.6   透明网桥的帧转发
    1、帧的转发过程
    （1）目的LAN与源LAN相同，则丢弃帧
    （2）目的LAN与源LAN不同，则转发帧
    （3）目的LAN位置，则洪泛帧
    当源LAN和目的LAN相同的时候，意味着源端发送的数据已经被目的端接收到了，因为局域网是广播传输的，网桥和目标端其实都接收到了数据。网桥判断源LAN和目的LAN就是通过端口号来进行的，网桥转发同一个LAN的数据的时候，从一个端口接受数据又从同一个端口发送。同理，当源LAN与目标LAN不同的时候，就可以单播转发。

    在目的LAN未知的时候就是没有找到对应的表项。网桥软件定期更新就是扫描端口，在规定时间内如果表项没有被刷新过，表项就被清除掉。表项被刷新过就是执行过逆向学习，每次发送数据都会执行逆向学习。

    2、网桥回路问题
    多个并行网桥产生回路的问题。

    透明网桥使用简单不需要任何配置，但是透明网桥在使用的时候有一个缺陷，转发数据帧的时候，对于目标方不识别的时候进行广播，那么如果对于存在回路的网络，就存在一个问题。

    ——————————————————————————————————————————————————————————————————局域网1
          |                                 |
         网桥1                            网桥2
         ①|                                 |
    ——————————————————————————————————————————————————————————————————局域网1
    |                     ②
    A

    为什么会出现这种情况？网桥是网络中的重要部件，对于无关紧要的末端点不需要做备份点，但是对网桥这种重要的节点一般会有备份节点，一旦有一个设备发生故障，另一个设备会马上接替使用，在某些情况下，备份还会不止一个，重要程度越高，备份越多。第二个网桥的作用就是起到了对第一个网桥的备份，这时候如果处理不当，非但起不到备份效果，还会导致混乱。有可能存在网络数据在网桥回路中转圈的现象。

    A发出一个帧，分别沿着①②两个方向发送，如果网桥1不认识目标地址，则网桥1进行广播，同样地网桥2发送数据帧的时候进行媒介载波侦听。网桥1和网桥2都发送数据帧的时候，在时序上由于载波侦听的缘故是岔开的，这样网桥1能接受到网桥2发送的数据，网桥2也能接受网桥1的数据，但是因为无法识别目标方，这就导致了数据帧不断在网桥1、2的回路中转圈。这是在目标地址不识别的情况下出现的数据帧不断传输的情况。

    站点A实际连接在网桥1、2的下端口，但是由于逆向地址学习，网桥2将A的数据转发到网桥1的时候，网桥1能识别目标地址，不进行转发，但是网桥1会学习到A的地址绑定到上端口，同理网桥2也会学到A绑定到上端口。

    本来网络端口和设备地址绑定具有唯一性，在没有唯一性的时候，上下端口都对应A，这时候还会存在转圈的情况。

    在不删掉其中一个网桥的情况下，有没有避免回路出现的方法呢？回路本质上是怎么产生的？导致数据帧绕圈的原因就是各个网桥机械地进行数据接收转发执行的，为避免绕圈，就必须要修改网桥的转发行为，主要网桥和备用网桥实际在功能上是不应该对等的，备用资源在主要资源有效的情况下，不应该做正常业务功能以免干扰。如果网桥1是主要资源，网桥2是备用资源，那么网桥2只接收数据帧但并不进行转发，网桥2不转发则在逻辑上断开了回路。

    解决多个网桥产生回路的问题：
        思想：让网桥之间相互通信，用一棵连接每个LAN的生成树(Spanning Tree)覆盖实际的拓扑结构。

        把有回路的图变成树就需要去掉一些连接，把网桥看成是图节点，网段看成节点之间的连线，当有网桥回路存在的时候，对应的图就会存在回路。这时候就可以删除部分节点，使某些节点的功能失效。在有回路的图中，消除回路不会损失网络的连通性，这种算法在数据结构和图论的时候有很多算法，使得任意两个节点之间只有单一路径联通。没有出现故障的时候通过生成树可以保障网络当中任意两个网段之间通信是没有问题的。生成树删除一些网桥，使被删除的网桥处于休眠状态，休眠状态的网桥只监测周边的网桥是否正常工作，当出现故障的时候，系统重新产生生成树，新的生成树仍然保证网络连通性不受损。

    3、生成树构造
    （1）网桥回路解决方案：
        a、让网桥之间相互通信，用一棵连接每个LAN的生成树（Spanning Tree）覆盖实际的拓扑结构
    （2）构造生成树
        a、每个桥广播自己的桥编号，号最小的桥成为生成树的根
        b、每个网桥计算自己到根的最短路径，构造出生成树，使得每个LAN和桥到根的路径最短
        c、当某个LAN或网桥发生故障时，重新计算生成树
        d、生成树构造完之后，算法继续执行以便自动发现拓扑结构变化，更新生成树

5.5.7   源路由网桥
    除了透明网桥之外还有源路由网桥，主要使用在IBM的令牌环网中，现在已经不是很多了。
    
    发送端有必要关注数据经过的网桥轨迹吗？站在用户的角度似乎没有必要关心，就像是寄信一样，我们不会关心信经过了哪些地点，只是关心送达的时效。

    透明网桥自动完成数据帧的转发过程，但是网桥的转发过程并不是始终符合人期待的转发要求，人期待的转发路径和执行过程中的路径未必是一致的。

    源端维护全局拓扑的形式在网络规模比较大的时候无法实现。
    1、透明网桥容易安装，但网络资源的利用不充分
    2、源路由（source route）网桥在发送帧时将详细的路由信息放在帧的首部中
    3、源站以广播方式向欲通信的目的站发送一个发现帧，每个发现帧都记录所经过的路由
    4、发现帧到达目的站时就沿各自的路由返回源站。源站在得知这些路由之后，从所有可能的路由中选择出一个最佳路由。凡从该源站向该目的站发送的帧的首部，都必须携带源站所确定的这一路由信息。

5.5.8   以太网交换机
    1、通常都有多个端口，以太网交换机实质上就是一个多端口的网桥
    2、特点：
    （1）以太网交换机的每个端口都直接与主机相连，并且一般都工作在全双工方式
    （2）交换机能同时连通许多对的端口，使每一对相互通信的主机都能像独占通信媒体那样，进行无碰撞地传输数据
    （3）以太网交换机由于使用了专用的交换结构芯片，其交换速率就较高
    （4）物理端口类型相同

    以太网端口连接的是同构主机，连接同构主机的时候可以使用专用的芯片来实现，但是从灵活性上以太网交换机不如网桥，网桥是软件实现的。网桥在现在连接异构网络的能力缺少应用，目前使用的主要都是以太网交换机。