计算机网络原理笔记 42
Internet基本原理（四）
作者：赵明心    日期：2019/04/15

7.4.4   与IP地址相关的一组协议
    ARP协议：地址解析协议解决网络层地址（IP）地址与数据链路层地址（MAC地址）的映射问题
    ARP表用于存放（IP地址，MAC地址）对：
        IP地址              以太网MAC地址
    138.129.32.3        08-60-8c-42-29-93
    138.129.32.4        08-60-8c-2f-d2-2b
    138.129.32.5        08-60-2d-2-91-e3

    通常每个主机会存一个ARP表，用于存放映射关系。为什么需要映射?在本机使用arp -a可以查看本机的ARP映射表。

    ARP报文格式：

                硬件类型                 协议类型
    硬件地址长度       协议地址长度         操作
                    发送方硬件地址（0-3字节）
            发送方硬件地址（4-5字节）       发送方IP地址（0-1字节）
            发送方IP地址（2-3字节）         目的硬件地址（0-1字节）
                    目的硬件地址（2-5字节）
                    目的IP地址（0-3字节）
    
    在以太网中，一个主机一开机就会广播自己的MAC地址和IP地址绑定，一段时间内，主机关机后，其他主机会删除对应的ARP表。为了查找10.1.0.5的MAC地址，就需要借助ARP协议。广播域内的所有主机都会收到ARP请求包，对应主机收到之后就会发送响应包给发送请求的主机。

    此处略去一张图。

    路由器需要完成数据的接收和转发，下面借助IP协议和ARP协议来解释这个过程。

    源主机发送数据时，自顶向下对数据进行封装，测试目的IP，是否在本子网内？如果是的话，则通过ARP协议获取目的IP地址的MAC地址并封装802.3帧，广播发送。如果不是，则先读取本机设置的网关IP地址，通过ARP协议获取网关的MAC地址，广播发出帧。

    不管中间经过了几跳路由器，目的IP地址都是不能变的。变化的只是MAC地址。R路由器接收数据之后对数据进行路由选择，看看有没有到达目的端B的路由。

    网关收到帧之后，解析帧，取出IP分组，获取目的IP地址，并通过路由表获取下一跳的IP地址（或接口），再通过ARP协议获取下一跳IP地址的MAC地址，封装802.3帧，广播...一直到出口网关（B所在的子网）。

    网关收到802.3帧后，解析，取出IP分组，通过ARP协议获取目的IP的MAC地址，封装802.3帧之后再广播发出。

    目的PC接收到802.3帧后，解析IP分组，取出UDP/TCP报文，转交给上层应用。

7.4.4.1 RARP协议
    反向地址解析协议用于将一个已知的MAC地址映射到IP地址。
    1、RARP要依赖于RARP服务器，该服务器中有一张MAC地址与IP地址的映射表
    2、需要查找自己IP地址的站点向网上发送包含有其MAC地址的RARP广播，RARP服务器收到后将该MAC地址翻译成IP地址予以响应。

    ARP是IP到MAC地址，RARP是已知的MAC去找对应的IP。为什么主机会不知道自己的IP地址呢？这个通常是用于无盘的工作站，每个主机只知道自己的MAC地址，主机需要向服务器申请自己的IP地址。

    当一个主机发送RARP协议的时候，向本网络广播，这个时候本网络的RARP服务器响应该数据包，并返回绑定好的MAC地址和IP地址。

7.4.4.2 引导协议BOOTP
    引导协议，一种基于UDP的协议。
    1、BOOTP主要用于无盘工作站从服务器得到自己的IP地址、服务器的IP地址、启动映像文件名、网关IP等等。
    2、其工作原理与RARP协议类似。

    获取IP地址的过程如下：
    （1）首先，客户端使用广播形式以IP地址255.255.255.255向网络中发出IP地址查询要求
    （2）运行BOOTP协议的服务器接收到这个请求，会发送一个含有IP地址、服务器IP地址、网关等信息的FOUND帧
    （3）客户端会根据该FOUND帧来获得自己的IP地址。

7.4.4.3 DHCP协议
    动态地址配置协议，Dynamic Host Configuration Protocol
    1、DHCP是BOOTP的扩展，基于客户/服务器模式的，提供了一种动态指定IP地址和配置参数的机制
    2、DHCP的工作原理：
        （1）寻找DHCP服务器
        （2）提供IP租用地址
        （3）接受IP租约
    
    这是配置网络协议的时候常用的另外一个协议类型，TCP/IP配置的时候有一个选项是自动获得IP地址，这是除了指定之外一个自动获得IP的方法。这个过程由DHCP协议来负责，类似于BOOTP过程，需要有一个专门响应地址分配的服务器。具体原理这里略去，需要自行了解。

    IP地址租用是在某个时间段内可以使用这个IP地址，之后用户可以接受租约，超过期限或一定条件的话就会让出IP地址。