计算机网络原理笔记 32
局域网技术（十二）
作者：赵明心    日期：2019/04/01

信道检测的代价主要是能耗过大。

5.12.2  隐蔽站问题

    这种未能检测出媒体上已存在的信号的问题叫做隐蔽站问题(hidden station problem)

    A的作用范围   C的作用范围
       A-----B--|---C-----D

    由于C没有落在A的信号范围内，所以认为B是空闲的，同理对于C来说，也无法发现A，导致AC都认为 B是空闲的，这时候向B发送信号的话就会导致冲突，产生碰撞。

    在有线网上不存在这个问题，共享介质的所有节点都可以看到所有在使用的节点，不存在看不到的  情况，但是在无线网中就存在这种情况，这种问题不会随着时间的推移而趋向于一致。

5.12.3  暴露站问题
    其实B向A发送数据并不影响C向D发送数据，这就是暴露站问题。

    B向A发送数据，此时C检测到B在发送数据就不发送数据，但是实际上是可以的，因为D并不在B的覆盖范围，而不会发生冲突。

    无线以太网中不再适用冲突检测方案而是改用冲突避免机制。

5.12.4  CSMA/CA的引入
    1、无线局域网不能使用CSMA/CD，而只能使用改进的CSMA协议
    2、改进的办法是将CSMA增加一个冲突避免（Collision Avoidance）功能
    3、802.11就使用CSMA/CA协议，而在使用CSMA/CA的同时还增加使用确认机制。

    注意这里还增加了确认机制，此时无线以太网向上提供的就是可靠的服务，传统以太网使用的是不可靠服务。无线通信环境比起有线通信环境相比，无线通信效果更差，那为什么无线网络提供的是可靠数据传输？这其实是一个概念的问题，可靠传输与否与使用的介质无关，可靠传输只是增加了可靠性保障机制，由于无线通信环境恶劣，导致误码率高、差错率高，这种方式直接被上层使用的话通信质量会很差，在MAC层使用可靠通信可以屏蔽下层通信环境恶劣对上层的影响。

    退一步讲，无线网络出现问题的可能性大了，按照分层原则，低层出现问题的频率过高，则问题的处理应当在下层，如果低层的差错比较少，则可以将差错处理放在更高的层次。分层原则功能的设计应该偏高偏低应该看出现的频度。

    CSMA/CA的功能层次

    MAC层通过协调功能来确定在基本服务集BSS中的移动站在什么时间能发送数据或接收数据。

                      无争用服务
                     点协调功能PCF
            （Point Coordination Function）
    MAC层                      分布协调功能DCF                <----争用服务
                   （Distributed Coordination Function）
                                 (CSMA/CA)
    物理层    2.4GHZ        2.4GHZ          IR       5GHZ        2.4GHZ
              FHSS          DSSS          1Mbps      OFDM        DSSS
              1Mbps         1Mbps         2Mbps    6，9，12      5.5Mbps
              2Mbps         2Mbps                 18，24，36     11Mbps
                                                  48，54Mbps
    
    点协调功能就在中央控制点的控制下进行信道占用，这个时候就是没有争用的，因为是由中央节点进行指派的。在分布协调当中，各个站点是等同的，存在冲突的可能，避免冲突，就使用预约协商机制。通过预约协商来明确数据发送顺序避免一拥而上抢占信道。

5.12.5  帧间间隔
    1、站在完成发送后，必须再等待一段很短的时间（继续监听）才能发送下一帧，这段时间统称是帧间间隔IFS(InterFrame Space)
    2、帧间间隔长度取决于该站欲发送的帧的类型。高优先级帧需要等待的时间较短。
    3、低优先级帧还没来得及发送而其他站的高优先级帧已经送到媒体，则低优先级的帧只能再推迟发送，减少冲突的机会。
    4、三种IFS类型
        （1）SIFS,短（Short）帧间间隔，长度为28us
        （2）PIFS，点协调功能帧间间隔，长度为78us
        （3）DIFS，分布协调功能帧间间隔，长度为128us

    有线以太网中的帧间间隔设置主要是为了接收端有一定的数据接收处理时间来清空缓冲区，而无线局域网中的设置不同。无线以太网中，存在着高优先级帧和低优先级帧，注意这个帧统称数据帧，而不是业务数据帧。在无线以太网中，由于预约机制的存在，一种是业务数据帧，一种是控制帧，用来进行预约。在这两种帧当中，控制帧的优先级更高。在操作系统中也存在优先级的设置，优先级的设置还跟时序有关，高优先级的与低优先级出现在一起，那么高优先级可以先调度，如果低优先级已经在进行处理，这时候在抢占式系统上，可以完成对低优先级的抢占。

    不同的抢占式策略影响了优先级的作用，而以太网中使用了第二种，也就是一次应用会话的原子性必须得到保证，一次数据300字节，不可以在传输到80字节的时候被高优先级打断，必须在300字节传输完成之后才可以进行高优先级帧的处理。

5.12.6  CSMA/CA协议的原理
    1、待发送数据的站先检测信道，在802.11标准中规定了在物理层的空中接口进行物理层的载波监听。
    2、通过收到的相对信号强度是否超过一定的门限数值就可以判定是否有其他的移动站在信道上发送数据。
    3、当源站发送它的第一个MAC帧（数据帧）时，若检测到信道空闲，则在等待一段时间DIFS后就可发送
        目的：让可能存在的高优先级帧先发送
    4、源站发送了自己的数据帧
    5、目的站若正确收到此帧，则经过时间间隔SIFS之后，向源站发送确认帧ACK
    6、若源站在规定时间内没有收到确认帧ACK（由重传计时器控制这段时间），就必须重传此帧，直到收到确认为止，或者经过若干次重传失败之后放弃发送。

    如果一个站点本身需要发送高优先级的帧，就不需要进行等待了，检测到信道空闲就直接发送即可。同等优先级的情况下都是基于时序优先。

    注意确认帧ACK的优先级高，ACK帧是控制帧。无线以太网的数据传输，从最后两条可以看到是可靠的，可靠性的保障依赖的是应答加重传机制。可靠性传输与数据传输的成功与否不是一回事，成功与否是站在用户的角度，用户希望数据能够发送成功，但是数据是否可以真正成功是不一定的。

5.12.7  虚拟载波侦听
    在之前的时候，载波侦听需要不停进行，使用冲突避免方式，可以不需要时刻监听。但是不管是冲突避免还是冲突检测，都需要执行信道检测，在发送数据之前进行信道监测，来看信道是否被占用了，这个过程，如果一个发送方需要使用信道，则需要不断的查看信道是否处于空闲状态，如果是永久坚持式CSMA/CD，就需要一直监听。这个过程在有源设备中问题不大，但是在无源设备中就是问题，如果使用随机隔一段时间来检测信道，会导致时间上的浪费。

    导致之前问题的根本原因就是已经抢占信道的站点在使用信道的时候，没有对抢占信道的时间进行约定，网络中的其他站点不清楚数据发送需要占用多久，别的站点不清楚的话只能通过一直监测信道的方式来查看信道是否空闲。如果进行一点改进，例如发送站先给出声明，声明发送数据需要占用信道多长时间，当发送方声明需要占用信道2秒钟的时候，在2秒以内其他站点无需继续监测，可以认为信道始终处于忙碌状态。

    这个认为信道忙的判定并不是来自于载波侦听，而是由于之前的声明。物理载波信道侦听只能判定当前时刻点是忙碌的，无法判断时间段的情况。

    1、虚拟载波监听（Virtual Carrier Sense）：源站在MAC帧首部中的第二个字段将它要占用信道的时间（包括目的站发回确认帧需要的时间）通知给所有其他站，以便使所有站在这一段时间都停止发送数据
    2、大大减少冲突机会
    3、“虚拟载波监听”表示其他站并没有真正地监听信道，而是由于其他站收到了“源站的通知”才不发送数据。

5.12.8  网络分配向量
    1、当一个站检测到正在信道中传送的MAC帧首部的“持续时间”字段时，就调整自己的网络分配向量NAV（Network Allocation Vector）
    2、NAV指出了必须经过多少时间才能完成数据帧的这次传输，才能使信道转入到空闲状态。

    无论怎样，只要网络分配向量不是0，其中有值，那么当前信道就是被使用的。

5.12.9  争用窗口
    1、信道从忙状态变为空闲时，任何一个站要发送数据帧时，不仅都必须等待一个DIFS的间隔，而且还要进入争用窗口，并计算随机退避时间以便再次重新试图接入到信道
    2、在信道从忙状态转为空闲时，各站就需要执行退避算法，这样做就减少了发生碰撞的概率。
    3、802.11使用二进制指数退避算法。

    二进制指数退避算法，这个指数退避算法跟之前的指数退避有一点点区别，就是计算的起始数据不一样。

    第i次退避就在2^(i+1)个时隙中随机地选择一个
    （1）第1次退避是在8个时隙（而不是2个）中随机选择一个
    （2）第2次退避是在16个时隙（而不是4个）中随机选择一个

5.12.10 RTS信道预约
    事实上，有了以上的机制仍然无法避免冲突，两个优先级相同的站点，同时检测到空闲，同时生成了相同的退避时间，这个时候仍然会发生冲突。冲突避免并没有完整实现。

    部分冲突避免是针对的控制帧，要注意对业务数据帧来说是绝对没有冲突的。节点抢占信道之后，首先发送的帧不是业务数据帧而是协商帧，协商帧有可能有冲突，但是冲突概率低，数据冲突是可以避免的，控制帧冲突不能绝对避免。

          A作用范围     B作用范围
        RTS        RTS
    C---------A----------B---------D

    源站A在发送数据帧之前先发送一个短的控制帧，叫做请求发送RTS（Request To Send），它包括源地址、目的地址和这次通信（包括相应的确认帧）所需的持续时间。这次通信所持续的时间就是为第三方站点填充网络分配向量使用的。A站点发送了请求帧时候不意味着请求可以成功还要依赖于目标方的应答。

    若媒体空闲，则目的站B就发送一个响应控制帧，叫做允许发送CTS（Clear To Send）

    A收到CTS帧后就可发送其数据帧。源端正确发送RTS并正确接收CTS之后才可以进行通信，这两步做到之后就可以保证不会再发生冲突，因为这个时候第三方都已经填充了各自的网络分配向量。

    此处略去一张帧间传输时间关系图。

5.13    IEEE 802.16 宽带无线网络
    1、覆盖城市的部分区域，网络跨距较大
        （1）被称为无线WAN
        （2）对于基站的功率，网络安全性都有较高的要求
    2、每个单元的用户数量比IEEE 802.11多
        （1）需要更高的带宽
        （2）称为宽带无线网络标准
    3、IEEE 802.16工作环境通常在室外
        （1）容易受到天气等因素的干扰
    4、设计目标是能够支持实时流应用的服务质量要求
        IEEE 802.11只是提供一定程度的支持
    
    802.16可以达到公里级别，频谱覆盖范围大，速率可以达到上百兆，有个外号叫无线光纤。